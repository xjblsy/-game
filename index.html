<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·±æµ·éœ¸ä¸» - è¿›åŒ–ä¹‹è·¯</title>
    <style>
        :root {
            --primary-glow: #00f2fe;
            --danger-glow: #ff4757;
            --ui-bg: rgba(10, 25, 45, 0.85);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            user-select: none; /* ç¦æ­¢é€‰ä¸­æ–‡æœ¬ */
        }
        
        body {
            background: #000;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            color: white;
        }
        
        /* åŠ¨æ€èƒŒæ™¯ */
        .bg-gradient {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #1a2a6c, #b21f1f, #fdbb2d); 
            background: linear-gradient(180deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            z-index: -1;
        }

        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        /* é€šç”¨ç»ç’ƒæ‹Ÿæ€é¢æ¿ */
        .glass-panel {
            background: var(--ui-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            padding: 40px;
            text-align: center;
            transition: transform 0.3s;
        }

        /* ç™»å½•ç•Œé¢ */
        .login-container {
            max-width: 400px;
            width: 90%;
        }
        
        .title {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(79, 172, 254, 0.5);
        }

        input, button {
            outline: none;
            font-size: 1.1rem;
        }

        .password-input {
            width: 100%;
            padding: 12px 20px;
            border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            color: white;
            margin: 20px 0;
            text-align: center;
            transition: 0.3s;
        }

        .password-input:focus {
            border-color: var(--primary-glow);
            box-shadow: 0 0 15px rgba(0, 242, 254, 0.3);
        }
        
        .btn {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            border: none;
            color: white;
            padding: 12px 40px;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 242, 254, 0.4);
            transition: 0.3s;
        }
        
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 242, 254, 0.6);
        }

        /* æ¸¸æˆä¸»å®¹å™¨ */
        .game-wrapper {
            display: none; /* åˆå§‹éšè— */
            position: relative;
            width: 100%;
            height: 100%;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* HUD (Heads-up Display) */
        .hud {
            position: absolute;
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€ */
            padding: 20px;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .hud-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .stats-box {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 20px;
            border-left: 4px solid var(--primary-glow);
            color: #fff;
        }

        .stat-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
            font-size: 1.1rem;
        }

        .life-heart {
            color: var(--danger-glow);
            font-size: 1.2rem;
            text-shadow: 0 0 10px var(--danger-glow);
        }

        /* æŠ€èƒ½æ  */
        .skill-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            pointer-events: auto;
        }

        .skill-slot {
            position: relative;
            width: 60px;
            height: 60px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .skill-slot.active {
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .skill-icon {
            font-size: 1.5rem;
        }

        .skill-key {
            font-size: 0.8rem;
            opacity: 0.7;
            position: absolute;
            bottom: 2px;
            right: 5px;
        }

        /* å†·å´é®ç½© */
        .cooldown-mask {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            background: rgba(0, 0, 0, 0.7);
            transition: height 0.1s linear;
        }
        
        .overlay-msg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            display: none;
        }
        
        .loading-bar-bg {
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            margin-top: 20px;
            overflow: hidden;
        }
        
        .loading-bar-fill {
            height: 100%;
            background: var(--primary-glow);
            width: 0%;
            transition: width 0.2s;
        }

        /* æµ®åŠ¨æ–‡å­—ç‰¹æ•ˆ */
        .floating-text {
            position: absolute;
            font-weight: bold;
            pointer-events: none;
            animation: floatUp 1s forwards;
            text-shadow: 0 0 5px black;
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-30px) scale(1.2); opacity: 0; }
        }

    </style>
</head>
<body>

    <div class="bg-gradient"></div>

    <div class="container">
        
        <div id="loginPanel" class="glass-panel login-container">
            <h1 class="title">æ·±æµ·éœ¸ä¸»</h1>
            <p style="opacity: 0.8; margin-bottom: 20px;">E V O L U T I O N</p>
            <input type="password" id="passInput" class="password-input" placeholder="è¾“å…¥è®¿é—®å¯†é’¥">
            <button id="btnLogin" class="btn">æ½œå…¥æ·±æµ·</button>
            <p id="errorMsg" style="color: #ff6b6b; margin-top: 10px; display: none;">å¯†é’¥æ— æ•ˆ</p>
            
            <div id="loadingArea" style="display: none;">
                <p id="loadingText">æ­£åœ¨ç”Ÿæˆç”Ÿæ€ç³»ç»Ÿ...</p>
                <div class="loading-bar-bg">
                    <div id="loadingFill" class="loading-bar-fill"></div>
                </div>
            </div>
        </div>

        <div id="gameWrapper" class="game-wrapper">
            <canvas id="gameCanvas"></canvas>
            
            <div class="hud">
                <div class="hud-top">
                    <div class="stats-box">
                        <div class="stat-row">ç”Ÿå‘½: <span id="uiLives"></span></div>
                        <div class="stat-row">åˆ†æ•°: <span id="uiScore">0</span></div>
                        <div class="stat-row">ä½“å‹: <span id="uiSize">15</span></div>
                    </div>
                    <div class="stats-box" style="border-left-color: #ffd700;">
                        <div class="stat-row">è¿›åŒ–ç­‰çº§: <span id="uiLevel">1</span></div>
                        <div class="stat-row" style="font-size: 0.8rem; opacity: 0.8;">ç›®æ ‡: 150cm</div>
                    </div>
                </div>

                <div class="skill-bar">
                    <div class="skill-slot" id="skillDash">
                        <span class="skill-icon">âš¡</span>
                        <span class="skill-key">SPACE</span>
                        <div class="cooldown-mask" id="cdDash"></div>
                    </div>
                    <div class="skill-slot" id="skillShield">
                        <span class="skill-icon">ğŸ›¡ï¸</span>
                        <span class="skill-key">J</span>
                        <div class="cooldown-mask" id="cdShield"></div>
                    </div>
                    <div class="skill-slot" id="skillMagnet">
                        <span class="skill-icon">ğŸ§²</span>
                        <span class="skill-key">K</span>
                        <div class="cooldown-mask" id="cdMagnet"></div>
                    </div>
                </div>
            </div>

            <div id="startScreen" class="glass-panel overlay-msg" style="display: block;">
                <h1 class="title">å‡†å¤‡å°±ç»ª</h1>
                <p>æ–¹å‘é”®ç§»åŠ¨ | SPACE å†²åˆº | J æŠ¤ç›¾ | K å¸é™„</p>
                <p style="margin: 15px 0; color: #ffd700;">åƒæ‰å°é±¼ï¼Œèº²é¿å¤§é±¼ï¼Œæˆä¸ºæ·±æµ·ä¹‹ç‹</p>
                <button id="btnStart" class="btn">å¼€å§‹è¿›åŒ–</button>
            </div>

            <div id="gameOverScreen" class="glass-panel overlay-msg">
                <h1 class="title" style="color: #ff4757; background: none; -webkit-text-fill-color: #ff4757;">ç‹©çŒå¤±è´¥</h1>
                <p>æ·±æµ·æ®‹é…·ï¼Œé€‚è€…ç”Ÿå­˜ã€‚</p>
                <p>æœ€ç»ˆå¾—åˆ†: <span id="finalScore"></span></p>
                <button onclick="resetGame()" class="btn" style="margin-top: 15px;">å†æ¬¡å°è¯•</button>
            </div>

            <div id="winScreen" class="glass-panel overlay-msg">
                <h1 class="title" style="color: #ffd700; background: none; -webkit-text-fill-color: #ffd700;">è¿›åŒ–å·…å³°</h1>
                <p>ä½ å·²æˆä¸ºè¿™ç‰‡æµ·åŸŸçš„ç»å¯¹éœ¸ä¸»ï¼</p>
                <p>æ— äººèƒ½æ•Œï¼</p>
                <button onclick="resetGame()" class="btn" style="margin-top: 15px;">ç»Ÿæ²»æ–°æµ·åŸŸ</button>
            </div>
        </div>
    </div>

<script>
/**
 * æ¸¸æˆé…ç½®ä¸æ ¸å¿ƒé€»è¾‘
 */
const CONFIG = {
    pass: 'xjblsy999',
    baseSpeed: 5,
    friction: 0.96, // æ‘©æ“¦åŠ›ï¼Œæ¨¡æ‹Ÿæ°´çš„é˜»åŠ›
    acceleration: 0.5,
    maxLives: 3,
    winSize: 150,
    skills: {
        dash: { duration: 500, cd: 4000, speedMult: 2.5 },
        shield: { duration: 2000, cd: 10000, color: 'rgba(255, 215, 0, 0.4)' },
        magnet: { duration: 3000, cd: 8000, range: 250, force: 2 }
    }
};

// ç”»å¸ƒä¸Šä¸‹æ–‡
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let animationId;

// æ¸¸æˆçŠ¶æ€
let game = {
    active: false,
    paused: false,
    width: 0,
    height: 0,
    camera: { x: 0, y: 0 }, // é¢„ç•™æ‘„åƒæœºé€»è¾‘ï¼Œç›®å‰ç®€å•å®ç°
    particles: [], // ç²’å­ç³»ç»Ÿ
    bubbles: [],   // èƒŒæ™¯æ°”æ³¡
    enemies: [],
    lastTime: 0
};

// ç©å®¶å¯¹è±¡
let player = {
    x: 0, y: 0,
    vx: 0, vy: 0,
    radius: 15,
    angle: 0,
    color: '#00f2fe',
    tailPhase: 0, // å°¾å·´æ‘†åŠ¨ç›¸ä½
    lives: 3,
    score: 0,
    invincible: false,
    skills: {
        dash: { active: false, cd: 0, maxCd: CONFIG.skills.dash.cd },
        shield: { active: false, cd: 0, maxCd: CONFIG.skills.shield.cd },
        magnet: { active: false, cd: 0, maxCd: CONFIG.skills.magnet.cd }
    }
};

// è¾“å…¥çŠ¶æ€
const keys = { ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false };

/**
 * é±¼ç±»å®šä¹‰ä¸é¢œè‰²åº“
 */
const FISH_TYPES = [
    { name: "Neon Tetra", colorStart: "#ff00cc", colorEnd: "#333399", minR: 5, maxR: 12, speed: 2.5 },
    { name: "Goldie", colorStart: "#fdbb2d", colorEnd: "#22c1c3", minR: 10, maxR: 20, speed: 2.0 },
    { name: "Abyss Ray", colorStart: "#00c6ff", colorEnd: "#0072ff", minR: 18, maxR: 30, speed: 1.8 },
    { name: "Hunter", colorStart: "#11998e", colorEnd: "#38ef7d", minR: 25, maxR: 45, speed: 1.6 },
    { name: "Titan", colorStart: "#8E2DE2", colorEnd: "#4A00E0", minR: 40, maxR: 60, speed: 1.4 },
    { name: "Leviathan", colorStart: "#cb2d3e", colorEnd: "#ef473a", minR: 60, maxR: 100, speed: 1.2 }
];

/* ================= åˆå§‹åŒ–ä¸å·¥å…·å‡½æ•° ================= */

function resize() {
    canvas.width = document.querySelector('.container').clientWidth;
    canvas.height = document.querySelector('.container').clientHeight;
    game.width = canvas.width;
    game.height = canvas.height;
}

window.addEventListener('resize', resize);

// åˆå§‹åŒ–èƒŒæ™¯æ°”æ³¡
function initBubbles() {
    game.bubbles = [];
    for(let i=0; i<30; i++) {
        game.bubbles.push({
            x: Math.random() * game.width,
            y: Math.random() * game.height,
            r: Math.random() * 3 + 1,
            speed: Math.random() * 0.5 + 0.1,
            alpha: Math.random() * 0.3
        });
    }
}

// ç²’å­ç‰¹æ•ˆç”Ÿæˆ
function spawnParticles(x, y, color, count) {
    for(let i=0; i<count; i++) {
        game.particles.push({
            x: x, y: y,
            vx: (Math.random() - 0.5) * 8,
            vy: (Math.random() - 0.5) * 8,
            life: 1.0,
            color: color,
            size: Math.random() * 3 + 1
        });
    }
}

// æµ®åŠ¨æ–‡å­—
function showFloatingText(text, x, y, color) {
    const el = document.createElement('div');
    el.className = 'floating-text';
    el.innerText = text;
    el.style.left = x + 'px';
    el.style.top = y + 'px';
    el.style.color = color;
    document.getElementById('gameWrapper').appendChild(el);
    setTimeout(() => el.remove(), 1000);
}

/* ================= æ ¸å¿ƒæ¸¸æˆå¾ªç¯ ================= */

function gameLoop(timestamp) {
    if (!game.active || game.paused) return;
    
    const dt = timestamp - game.lastTime;
    game.lastTime = timestamp;

    ctx.clearRect(0, 0, game.width, game.height);

    updateLogic(dt);
    drawScene();
    updateUI(dt);

    animationId = requestAnimationFrame(gameLoop);
}

function updateLogic(dt) {
    // 1. ç©å®¶ç§»åŠ¨ (ç‰©ç†æ¨¡æ‹Ÿ)
    // æ ¹æ®ä½“å‹è®¡ç®—å½“å‰æœ€å¤§é€Ÿåº¦ (ä½“å‹è¶Šå¤§è¶Šæ…¢)
    let currentMaxSpeed = CONFIG.baseSpeed * (20 / (20 + player.radius * 0.5)); 
    // æŠ€èƒ½åŠ é€Ÿ
    if (player.skills.dash.active) currentMaxSpeed *= CONFIG.skills.dash.speedMult;

    // åŠ é€Ÿåº¦åº”ç”¨
    if (keys.ArrowUp) player.vy -= CONFIG.acceleration;
    if (keys.ArrowDown) player.vy += CONFIG.acceleration;
    if (keys.ArrowLeft) player.vx -= CONFIG.acceleration;
    if (keys.ArrowRight) player.vx += CONFIG.acceleration;

    // æ‘©æ“¦åŠ›ä¸é™é€Ÿ
    player.vx *= CONFIG.friction;
    player.vy *= CONFIG.friction;

    const speed = Math.sqrt(player.vx**2 + player.vy**2);
    if (speed > currentMaxSpeed) {
        const ratio = currentMaxSpeed / speed;
        player.vx *= ratio;
        player.vy *= ratio;
    }

    // æ›´æ–°ä½ç½®
    player.x += player.vx;
    player.y += player.vy;

    // è¾¹ç•Œé™åˆ¶
    if (player.x < player.radius) { player.x = player.radius; player.vx *= -0.5; }
    if (player.x > game.width - player.radius) { player.x = game.width - player.radius; player.vx *= -0.5; }
    if (player.y < player.radius) { player.y = player.radius; player.vy *= -0.5; }
    if (player.y > game.height - player.radius) { player.y = game.height - player.radius; player.vy *= -0.5; }

    // è®¡ç®—æ—‹è½¬è§’åº¦ (å¹³æ»‘è¿‡æ¸¡)
    if (speed > 0.1) {
        let targetAngle = Math.atan2(player.vy, player.vx);
        // è§’åº¦æ’å€¼ï¼Œé˜²æ­¢çªå˜
        let diff = targetAngle - player.angle;
        while (diff < -Math.PI) diff += Math.PI * 2;
        while (diff > Math.PI) diff -= Math.PI * 2;
        player.angle += diff * 0.1;
    }
    
    // å°¾å·´åŠ¨ç”»ç›¸ä½æ›´æ–°
    player.tailPhase += 0.2 + (speed / 5);

    // 2. æ•Œäººç”Ÿæˆä¸é€»è¾‘
    if (Math.random() < 0.03 && game.enemies.length < 25) {
        spawnEnemy();
    }

    game.enemies.forEach((e, index) => {
        // ç®€å•AI: åŠ ä¸Šæ­£å¼¦æ³¢æ‰°åŠ¨è®©æ¸¸åŠ¨æ›´è‡ªç„¶
        e.x += e.vx + Math.sin(Date.now() / 500) * 0.5;
        e.y += e.vy;
        e.tailPhase += 0.15;

        // ç£åŠ›å¸é™„æŠ€èƒ½é€»è¾‘
        if (player.skills.magnet.active && e.r < player.radius * 0.9) {
            const dx = player.x - e.x;
            const dy = player.y - e.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if (dist < CONFIG.skills.magnet.range) {
                e.x += (dx / dist) * CONFIG.skills.magnet.force;
                e.y += (dy / dist) * CONFIG.skills.magnet.force;
            }
        }

        // ç§»é™¤å‡ºç•Œ
        if (e.x < -200 || e.x > game.width + 200 || e.y < -200 || e.y > game.height + 200) {
            game.enemies.splice(index, 1);
            return;
        }

        // ç¢°æ’æ£€æµ‹
        const dx = player.x - e.x;
        const dy = player.y - e.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        
        if (dist < player.radius + e.r) {
            handleCollision(e, index);
        }
    });

    // 3. ç²’å­é€»è¾‘
    for(let i = game.particles.length -1; i >= 0; i--) {
        let p = game.particles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.life -= 0.05;
        if (p.life <= 0) game.particles.splice(i, 1);
    }
}

function spawnEnemy() {
    // æ¦‚ç‡æ§åˆ¶ï¼šæ ¹æ®ç©å®¶å¤§å°ï¼Œç”Ÿæˆæ›´å¤§é±¼çš„æ¦‚ç‡å¢åŠ 
    let tier = 0;
    const r = Math.random();
    // åŠ¨æ€è°ƒæ•´ç”Ÿæˆéš¾åº¦
    const difficultyMod = Math.min(0.5, player.radius / 200); 
    
    if (r < 0.5 - difficultyMod) tier = Math.floor(Math.random() * 2); // 0-1
    else if (r < 0.8 - difficultyMod/2) tier = Math.floor(Math.random() * 2) + 2; // 2-3
    else tier = Math.floor(Math.random() * 2) + 4; // 4-5

    const type = FISH_TYPES[tier];
    const side = Math.random() > 0.5 ? 'left' : 'right';
    
    let fish = {
        x: side === 'left' ? -100 : game.width + 100,
        y: Math.random() * game.height,
        vx: side === 'left' ? type.speed * (0.8 + Math.random()*0.4) : -type.speed * (0.8 + Math.random()*0.4),
        vy: (Math.random() - 0.5) * 0.5,
        r: type.minR + Math.random() * (type.maxR - type.minR),
        colorStart: type.colorStart,
        colorEnd: type.colorEnd,
        angle: side === 'left' ? 0 : Math.PI,
        tailPhase: 0
    };
    game.enemies.push(fish);
}

function handleCollision(enemy, index) {
    if (player.radius > enemy.r * 1.05) { // å¿…é¡»ç¨å¾®å¤§ä¸€ç‚¹
        // åƒæ‰
        game.enemies.splice(index, 1);
        spawnParticles(enemy.x, enemy.y, enemy.colorStart, 10);
        showFloatingText(`+${Math.floor(enemy.r)}`, player.x, player.y - player.radius, '#ffd700');
        
        player.score += Math.floor(enemy.r);
        // æˆé•¿æ›²çº¿ï¼šè¶Šå¤§é•¿å¾—è¶Šæ…¢
        player.radius += (enemy.r / player.radius) * 0.8; 
        
        if (player.radius >= CONFIG.winSize) winGame();
    } else if (enemy.r > player.radius * 1.05) {
        // è¢«æ’
        if (player.skills.shield.active || player.invincible) return; // æŠ¤ç›¾æˆ–æ— æ•Œ

        player.lives--;
        player.invincible = true;
        game.enemies.splice(index, 1); // æ•Œäººåƒæ‰ä½ åæ¶ˆå¤±ï¼Œé˜²æ­¢è¿ç»­åˆ¤å®š
        
        spawnParticles(player.x, player.y, '#ff4757', 20);
        showFloatingText("-1 ç”Ÿå‘½", player.x, player.y, '#ff4757');
        
        // å—ä¼¤æ— æ•Œæ—¶é—´
        canvas.style.opacity = 0.5;
        setTimeout(() => { 
            player.invincible = false; 
            canvas.style.opacity = 1; 
        }, 1500);

        if (player.lives <= 0) gameOver();
    }
}

/* ================= æ¸²æŸ“ç³»ç»Ÿ (æ ¸å¿ƒè§†è§‰ä¼˜åŒ–) ================= */

function drawScene() {
    // 1. ç»˜åˆ¶èƒŒæ™¯æ°”æ³¡
    game.bubbles.forEach(b => {
        b.y -= b.speed;
        if(b.y < -10) b.y = game.height + 10;
        ctx.beginPath();
        ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
        ctx.fillStyle = `rgba(255, 255, 255, ${b.alpha})`;
        ctx.fill();
    });

    // 2. ç»˜åˆ¶ç©å®¶
    drawFish(player.x, player.y, player.radius, player.angle, player.color, '#00c6ff', player.tailPhase, true);

    // æŠ¤ç›¾ç‰¹æ•ˆ
    if (player.skills.shield.active) {
        ctx.beginPath();
        ctx.arc(player.x, player.y, player.radius + 10, 0, Math.PI*2);
        ctx.strokeStyle = `rgba(255, 215, 0, ${0.5 + Math.sin(Date.now()/100)*0.2})`;
        ctx.lineWidth = 3;
        ctx.shadowBlur = 10;
        ctx.shadowColor = '#ffd700';
        ctx.stroke();
        ctx.shadowBlur = 0;
    }
    // ç£åŠ›ç‰¹æ•ˆ
    if (player.skills.magnet.active) {
        ctx.beginPath();
        ctx.arc(player.x, player.y, CONFIG.skills.magnet.range, 0, Math.PI*2);
        ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
        ctx.fill();
        ctx.lineWidth = 1;
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
        ctx.stroke();
    }

    // 3. ç»˜åˆ¶æ•Œäºº
    game.enemies.forEach(e => {
        // è®¡ç®—æœå‘ï¼Œå¦‚æœé€Ÿåº¦å¾ˆæ…¢åˆ™ä¿æŒåŸè§’åº¦
        let angle = e.angle;
        if (Math.abs(e.vx) > 0.1) angle = Math.atan2(e.vy, e.vx);
        drawFish(e.x, e.y, e.r, angle, e.colorStart, e.colorEnd, e.tailPhase, false);
    });

    // 4. ç»˜åˆ¶ç²’å­
    game.particles.forEach(p => {
        ctx.globalAlpha = p.life;
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
        ctx.fill();
        ctx.globalAlpha = 1.0;
    });
}

/**
 * é«˜çº§é±¼ç±»ç»˜åˆ¶å‡½æ•° (ä¼ª3D + åŠ¨æ€å°¾å·´)
 */
function drawFish(x, y, r, angle, color1, color2, phase, isPlayer) {
    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(angle);

    // è®¾ç½®å‘å…‰æ•ˆæœ
    ctx.shadowBlur = isPlayer ? 20 : 10;
    ctx.shadowColor = color1;

    // åˆ›å»ºèº«ä½“æ¸å˜
    let grad = ctx.createRadialGradient(0, -r*0.2, r*0.2, 0, 0, r);
    grad.addColorStop(0, color1);
    grad.addColorStop(1, color2);
    ctx.fillStyle = grad;

    // ç»˜åˆ¶å°¾å·´ (ä½¿ç”¨æ­£å¼¦æ³¢æ‘†åŠ¨)
    const tailWiggle = Math.sin(phase) * (r * 0.3); 
    ctx.beginPath();
    ctx.moveTo(-r * 0.8, 0);
    ctx.lineTo(-r * 1.8, -r * 0.6 + tailWiggle);
    ctx.lineTo(-r * 1.5, 0 + tailWiggle); // å°¾å·´ä¸­é—´å‡¹é™·
    ctx.lineTo(-r * 1.8, r * 0.6 + tailWiggle);
    ctx.closePath();
    ctx.fill();

    // ç»˜åˆ¶ä¾§é³ (éšå‘¼å¸å¾‹åŠ¨)
    const finAngle = Math.PI/4 + Math.sin(phase)*0.2;
    ctx.beginPath();
    ctx.ellipse(r*0.2, r*0.6, r*0.4, r*0.15, finAngle, 0, Math.PI*2);
    ctx.ellipse(r*0.2, -r*0.6, r*0.4, r*0.15, -finAngle, 0, Math.PI*2);
    ctx.fillStyle = color2;
    ctx.fill();

    // ç»˜åˆ¶èº«ä½“ä¸»ä½“ (æ°´æ»´å½¢)
    ctx.beginPath();
    // å¤´éƒ¨æ›´åœ†ï¼Œå°¾éƒ¨ç•¥å°–
    ctx.ellipse(0, 0, r, r*0.8, 0, 0, Math.PI*2);
    ctx.fillStyle = grad;
    ctx.fill();

    // çœ¼ç› (æ€»æ˜¯çœ‹å‘å‰æ–¹)
    ctx.fillStyle = 'white';
    ctx.beginPath();
    ctx.arc(r*0.4, -r*0.3, r*0.25, 0, Math.PI*2); // å·¦çœ¼
    ctx.arc(r*0.4, r*0.3, r*0.25, 0, Math.PI*2);  // å³çœ¼
    ctx.fill();

    // ç³å­”
    ctx.fillStyle = 'black';
    ctx.beginPath();
    ctx.arc(r*0.5, -r*0.3, r*0.1, 0, Math.PI*2);
    ctx.arc(r*0.5, r*0.3, r*0.1, 0, Math.PI*2);
    ctx.fill();

    // é«˜å…‰ (å¢åŠ ç«‹ä½“æ„Ÿ)
    ctx.fillStyle = 'rgba(255,255,255,0.3)';
    ctx.beginPath();
    ctx.ellipse(r*0.2, -r*0.3, r*0.4, r*0.15, -0.2, 0, Math.PI*2);
    ctx.fill();

    ctx.shadowBlur = 0;
    ctx.restore();
}

/* ================= æŠ€èƒ½ç³»ç»Ÿä¸UI ================= */

function updateUI(dt) {
    // æ›´æ–°HUDæ•°æ®
    document.getElementById('uiScore').innerText = player.score;
    document.getElementById('uiSize').innerText = Math.floor(player.radius);
    
    // ç”Ÿå‘½å€¼æ¸²æŸ“ä¸ºå¿ƒå½¢
    let hearts = '';
    for(let i=0; i<player.lives; i++) hearts += 'â¤ ';
    document.getElementById('uiLives').innerHTML = `<span class="life-heart">${hearts}</span>`;

    // æŠ€èƒ½å†·å´ä¸æŒç»­æ—¶é—´é€»è¾‘
    updateSkillState('dash', dt);
    updateSkillState('shield', dt);
    updateSkillState('magnet', dt);
}

function updateSkillState(name, dt) {
    const skill = player.skills[name];
    const elMask = document.getElementById(`cd${name.charAt(0).toUpperCase() + name.slice(1)}`);
    const elSlot = document.getElementById(`skill${name.charAt(0).toUpperCase() + name.slice(1)}`);

    // å†·å´å€’è®¡æ—¶
    if (skill.cd > 0) {
        skill.cd -= dt;
        const percent = (skill.cd / skill.maxCd) * 100;
        elMask.style.height = `${percent}%`;
        elSlot.classList.remove('active');
    } else {
        elMask.style.height = '0%';
        if (skill.active) elSlot.classList.add('active'); // æ¿€æ´»ä¸­é«˜äº®
    }

    // æŒç»­æ—¶é—´ç»“æŸåå…³é—­çŠ¶æ€ï¼ˆä½†å†·å´å·²ç»åœ¨æŠ€èƒ½é‡Šæ”¾æ—¶å¼€å§‹è®¡ç®—ï¼‰
    // è¿™é‡Œç®€åŒ–ï¼šæŒç»­æ—¶é—´ç”± setTimeout æ§åˆ¶ï¼Œè§ activateSkill
}

function activateSkill(name) {
    const skillData = player.skills[name];
    const config = CONFIG.skills[name];

    if (skillData.cd <= 0 && !skillData.active) {
        skillData.active = true;
        skillData.cd = config.cd; // å¼€å§‹å†·å´
        
        // è§†è§‰åé¦ˆ
        showFloatingText(name.toUpperCase() + "!", player.x, player.y - 40, '#fff');

        // å®šæ—¶å…³é—­æŠ€èƒ½æ•ˆæœ
        setTimeout(() => {
            skillData.active = false;
        }, config.duration);
    }
}

/* ================= æ¸¸æˆæ§åˆ¶æµç¨‹ ================= */

// é”®ç›˜ç›‘å¬
window.addEventListener('keydown', e => {
    if(keys.hasOwnProperty(e.code)) keys[e.code] = true;
    
    // æŠ€èƒ½æŒ‰é”®
    if (game.active && !game.paused) {
        if (e.code === 'Space') activateSkill('dash');
        if (e.code === 'KeyJ') activateSkill('shield');
        if (e.code === 'KeyK') activateSkill('magnet');
    }
});

window.addEventListener('keyup', e => {
    if(keys.hasOwnProperty(e.code)) keys[e.code] = false;
});

// ç™»å½•ç³»ç»Ÿ
document.getElementById('btnLogin').addEventListener('click', () => {
    const pass = document.getElementById('passInput').value;
    if (pass === CONFIG.pass) {
        document.getElementById('loginPanel').querySelector('h1').style.display = 'none';
        document.getElementById('loginPanel').querySelector('p').style.display = 'none';
        document.getElementById('passInput').style.display = 'none';
        document.getElementById('btnLogin').style.display = 'none';
        document.getElementById('errorMsg').style.display = 'none';
        
        // æ¨¡æ‹ŸåŠ è½½
        const loading = document.getElementById('loadingArea');
        loading.style.display = 'block';
        const fill = document.getElementById('loadingFill');
        
        let width = 0;
        const timer = setInterval(() => {
            width += Math.random() * 5;
            if(width > 100) width = 100;
            fill.style.width = width + '%';
            if(width === 100) {
                clearInterval(timer);
                setTimeout(() => {
                    document.getElementById('loginPanel').style.display = 'none';
                    document.getElementById('gameWrapper').style.display = 'block';
                    resize();
                    initBubbles();
                    drawScene(); // ç»˜åˆ¶ä¸€å¸§èƒŒæ™¯
                }, 500);
            }
        }, 50);
    } else {
        const err = document.getElementById('errorMsg');
        err.style.display = 'block';
        err.classList.add('shake');
        setTimeout(() => err.classList.remove('shake'), 500);
    }
});

// å¼€å§‹æ¸¸æˆ
document.getElementById('btnStart').addEventListener('click', () => {
    document.getElementById('startScreen').style.display = 'none';
    resetGame();
});

function resetGame() {
    // é‡ç½®æ•°æ®
    player.x = game.width / 2;
    player.y = game.height / 2;
    player.vx = 0; player.vy = 0;
    player.radius = 15;
    player.lives = CONFIG.maxLives;
    player.score = 0;
    player.invincible = false;
    // é‡ç½®æŠ€èƒ½
    Object.keys(player.skills).forEach(k => {
        player.skills[k].cd = 0;
        player.skills[k].active = false;
    });

    game.enemies = [];
    game.particles = [];
    game.active = true;
    game.paused = false;
    game.lastTime = performance.now();
    
    document.getElementById('gameOverScreen').style.display = 'none';
    document.getElementById('winScreen').style.display = 'none';
    
    cancelAnimationFrame(animationId);
    requestAnimationFrame(gameLoop);
}

function gameOver() {
    game.active = false;
    document.getElementById('finalScore').innerText = player.score;
    document.getElementById('gameOverScreen').style.display = 'block';
}

function winGame() {
    game.active = false;
    document.getElementById('winScreen').style.display = 'block';
}

</script>
</body>
</html>
