<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Deep Sea Evolution: Fixed</title>
    <style>
        :root {
            --cyan: #00f2fe;
            --gold: #ffd700;
            --pink: #ff0055;
            --bg: #02040a;
            --glass: rgba(16, 24, 40, 0.9);
        }

        body {
            margin: 0; padding: 0; background: var(--bg);
            overflow: hidden; font-family: 'Segoe UI', sans-serif;
            color: white; width: 100vw; height: 100vh;
            display: flex; justify-content: center; align-items: center;
        }

        canvas { position: absolute; top: 0; left: 0; z-index: 1; }

        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; pointer-events: none;
        }

        /* é¢æ¿ç»„ä»¶ */
        .panel {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: var(--glass);
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 0 60px rgba(0, 242, 254, 0.15);
            backdrop-filter: blur(12px);
            padding: 40px; border-radius: 16px;
            text-align: center; min-width: 360px;
            pointer-events: auto; display: none;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .panel.active { display: block; }
        @keyframes popIn { from { transform: translate(-50%, -40%) scale(0.9); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }

        h1 { margin: 0 0 20px; font-size: 2rem; background: linear-gradient(to right, #fff, var(--cyan)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        input {
            background: rgba(0,0,0,0.5); border: 1px solid #444;
            color: #fff; padding: 14px; width: 100%; border-radius: 8px;
            font-size: 1.1rem; text-align: center; margin-bottom: 20px; outline: none;
        }
        input:focus { border-color: var(--cyan); box-shadow: 0 0 15px rgba(0,242,254,0.2); }

        .btn {
            background: linear-gradient(135deg, #0061ff, #00f2fe);
            border: none; padding: 12px 35px; border-radius: 50px;
            color: #000; font-weight: bold; font-size: 1rem; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: 0.2s;
        }
        .btn:hover { transform: scale(1.05); box-shadow: 0 8px 20px rgba(0,242,254,0.4); }
        .btn.outline { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: #fff; margin-top: 10px; }
        .btn.outline:hover { background: rgba(255,255,255,0.1); }

        /* å­˜æ¡£åˆ—è¡¨ */
        .slot-list { margin: 15px 0; max-height: 220px; overflow-y: auto; }
        .slot {
            background: rgba(255,255,255,0.05); padding: 12px; margin-bottom: 8px;
            border-radius: 8px; display: flex; justify-content: space-between;
            cursor: pointer; border: 1px solid transparent; transition: 0.2s;
        }
        .slot:hover { border-color: var(--cyan); background: rgba(0,242,254,0.1); }

        /* HUD */
        #hud { display: none; }
        .hud-top { position: absolute; top: 20px; left: 20px; display: flex; gap: 15px; }
        .stat { background: rgba(0,0,0,0.6); padding: 8px 16px; border-radius: 20px; border: 1px solid #333; font-weight: bold; }
        
        .skill-bar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; pointer-events: auto; }
        .sk-box {
            width: 64px; height: 64px; background: rgba(10,20,30,0.9);
            border: 2px solid #333; border-radius: 12px; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .sk-box.active { border-color: var(--gold); box-shadow: 0 0 20px rgba(255,215,0,0.3); }
        .sk-icon { font-size: 1.5rem; z-index: 2; }
        .sk-key { font-size: 0.7rem; color: #888; margin-top: 3px; z-index: 2; font-weight: bold; }
        .sk-cd { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background: rgba(0,0,0,0.8); z-index: 1; transition: height 0.1s linear; }

        .float-txt {
            position: absolute; font-weight: 900; font-size: 1.4rem; pointer-events: none;
            text-shadow: 0 2px 5px #000; animation: float 0.8s forwards;
        }
        @keyframes float { to { transform: translateY(-50px); opacity: 0; } }

        #err-log { position: fixed; top: 0; left: 0; width: 100%; background: #d00; color: #fff; text-align: center; display: none; z-index: 9999; }
    </style>
</head>
<body>

    <div id="err-log"></div>
    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div id="p-pass" class="panel active">
            <h1>SYSTEM LOCK</h1>
            <p>è¾“å…¥æœ€é«˜æƒé™å¯†é’¥</p>
            <input type="password" id="inp-pass" placeholder="Password">
            <button class="btn" onclick="App.checkPass()">ACCESS</button>
        </div>

        <div id="p-login" class="panel">
            <h1>IDENTITY</h1>
            <p>è¾“å…¥ä»£å· (æ‹¼éŸ³é¦–å­—æ¯)</p>
            <input type="text" id="inp-user" placeholder="ä¾‹å¦‚: BOSS" maxlength="10">
            <button class="btn" onclick="App.login()">CONNECT</button>
        </div>

        <div id="p-saves" class="panel">
            <h1>ARCHIVES</h1>
            <div class="slot-list" id="slot-list"></div>
            <button class="btn" onclick="App.newGame()">å¼€å§‹æ–°å¾ç¨‹</button>
            <br>
            <button class="btn outline" onclick="UI.show('p-login')">é€€å‡º</button>
        </div>

        <div id="p-win" class="panel">
            <h1 style="color:var(--gold)">DOMINATED</h1>
            <p>æµ·åŸŸå·²å¾æœ</p>
            <div style="text-align: left; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin: 15px 0;">
                <p style="margin:0; color:#fff">ä¸‹ä¸€ç«™: <b style="color:var(--pink)">æ·±æ¸Šç¦åŒº</b></p>
                <small style="color:#888">ç¯å¢ƒ: æåº¦é»‘æš— | å¨èƒ: å·¨å‹ç”Ÿç‰©</small>
            </div>
            <button class="btn" onclick="Game.nextLevel()">æ½œå…¥æ·±æ¸Š</button>
            <br>
            <button class="btn outline" onclick="App.saveQuit()">å­˜æ¡£ä¼‘æ¯</button>
        </div>

        <div id="p-dead" class="panel">
            <h1 style="color:var(--pink)">FAILURE</h1>
            <p>ç”Ÿå‘½è®¯å·æ¶ˆå¤±...</p>
            <button class="btn" onclick="Game.retry()">é‡ç»„åŸºå› </button>
            <br>
            <button class="btn outline" onclick="App.loadSaves()">è¿”å›</button>
        </div>

        <div id="hud">
            <div class="hud-top">
                <div class="stat" style="border-left:3px solid var(--pink); color:var(--pink)">â¤ <span id="v-lives">3</span></div>
                <div class="stat" style="border-left:3px solid var(--cyan); color:var(--cyan)">ğŸ“ <span id="v-size">0</span></div>
                <div class="stat">âš“ <span id="v-zone">Zone</span></div>
            </div>
            <div class="skill-bar">
                <div class="sk-box" id="s-dash"><div class="sk-icon">âš¡</div><div class="sk-key">SPACE</div><div class="sk-cd" id="c-dash"></div></div>
                <div class="sk-box" id="s-shield"><div class="sk-icon">ğŸ›¡ï¸</div><div class="sk-key">J</div><div class="sk-cd" id="c-shield"></div></div>
                <div class="sk-box" id="s-magnet"><div class="sk-icon">ğŸ§²</div><div class="sk-key">K</div><div class="sk-cd" id="c-magnet"></div></div>
                <div class="sk-box" id="s-sonar" style="display:none"><div class="sk-icon">ğŸ“¡</div><div class="sk-key">L</div><div class="sk-cd" id="c-sonar"></div></div>
            </div>
        </div>
    </div>

<script>
/* --- å…¨å±€é”™è¯¯å¤„ç† (é˜²æ­¢é»‘å±) --- */
window.onerror = function(msg, url, line) {
    const el = document.getElementById('err-log');
    el.style.display = 'block';
    el.innerText = `Error: ${msg} (Line ${line})`;
    console.error(msg);
    return false;
};

/* --- æ¸¸æˆé…ç½® --- */
const CFG = {
    PASS: 'xjblsy99',
    WORLD: 2800,
    LEVELS: [
        { id:0, name:"é˜³å…‰æµ…æ»©", target:60, startR:15, dark:0, bg:['#006994','#003366'], skills:['dash','shield','magnet'], spawns:['tetra','goldie','ray'] },
        { id:1, name:"æ·±æ¸Šç¦åŒº", target:200, startR:70, dark:0.96, bg:['#050505','#1a0b2e'], skills:['dash','shield','magnet','sonar'], spawns:['goldie','angler','shark','whale'] }
    ],
    // ä¿®å¤ï¼šç»Ÿä¸€ä½¿ç”¨ 'color' å±æ€§ï¼Œé¿å… undefined é”™è¯¯
    FISH: {
        tetra:  { r:[6,14],   spd:3.2, color:'#ff00cc', type:'neon' },
        goldie: { r:[15,28],  spd:2.4, color:'#ff9f43', type:'gold' },
        ray:    { r:[25,40],  spd:2.6, color:'#00d2d3', type:'flat' },
        angler: { r:[40,60],  spd:1.8, color:'#a55eea', type:'angler' },
        shark:  { r:[60,90],  spd:4.0, color:'#7f8fa6', type:'shark', aggro:true },
        whale:  { r:[100,180],spd:1.2, color:'#2f3542', type:'whale' }
    },
    SKILLS: {
        dash: {cd:3000, dur:300}, shield: {cd:12000, dur:3000},
        magnet: {cd:15000, dur:4000, r:450}, sonar: {cd:20000, dur:150, r:1200}
    }
};

/* --- å­˜å‚¨ç³»ç»Ÿ (Safe Mode) --- */
const Store = {
    mem: {}, ok: false,
    init() { try { localStorage.setItem('t','1'); localStorage.removeItem('t'); this.ok=true; } catch(e){} },
    get(k) { return this.ok ? localStorage.getItem(k) : this.mem[k]; },
    set(k,v) { if(this.ok) localStorage.setItem(k,v); else this.mem[k]=v; }
};
Store.init();

/* --- æ¸²æŸ“å¼•æ“ --- */
const Render = {
    // æ ¸å¿ƒä¿®å¤ï¼šæ·»åŠ é»˜è®¤é¢œè‰²fallbackï¼Œé˜²æ­¢æŠ¥é”™
    fish(ctx, x, y, r, ang, color, type, phase) {
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(ang);

        const safeColor = color || '#ffffff'; // é˜²æ­¢ undefined å´©æºƒ
        const swing = Math.sin(phase);

        // 1. èº«ä½“å…‰æ³½ (ä¼ª3D)
        const g = ctx.createRadialGradient(0, -r*0.3, r*0.1, 0, 0, r);
        g.addColorStop(0, '#fff');
        g.addColorStop(0.4, safeColor);
        g.addColorStop(1, '#000');

        // 2. ç»˜åˆ¶å°¾å·´ (éª¨éª¼æ¨¡æ‹Ÿ)
        ctx.fillStyle = safeColor;
        ctx.beginPath();
        if(type === 'shark') {
            // é²¨é±¼æœ‰åŠ›å°¾å·´
            ctx.moveTo(-r*0.8, 0);
            ctx.quadraticCurveTo(-r*1.6, swing*r*0.5, -r*2.4, -r*0.9+swing*r);
            ctx.lineTo(-r*2.4, r*0.9+swing*r);
            ctx.quadraticCurveTo(-r*1.6, swing*r*0.5, -r*0.8, 0);
        } else if(type === 'whale') {
            // é²¸é±¼å®½å°¾
            ctx.moveTo(-r*0.9, 0); ctx.quadraticCurveTo(-r*1.8, 0, -r*2.5, -r*0.6+swing*r*0.4);
            ctx.lineTo(-r*2.5, r*0.6+swing*r*0.4); ctx.quadraticCurveTo(-r*1.8, 0, -r*0.9, 0);
        } else {
            // æ™®é€šé±¼å°¾
            ctx.moveTo(-r*0.7, 0); ctx.lineTo(-r*1.5, -r*0.6+swing*8); ctx.lineTo(-r*1.5, r*0.6+swing*8);
        }
        ctx.fill();

        // 3. ä¾§é³ (å‘¼å¸åŠ¨ç”»)
        const finAng = 0.6 + Math.sin(phase*0.8)*0.3;
        ctx.beginPath(); ctx.ellipse(r*0.2, r*0.6, r*0.3, r*0.15, finAng, 0, Math.PI*2);
        ctx.ellipse(r*0.2, -r*0.6, r*0.3, r*0.15, -finAng, 0, Math.PI*2);
        ctx.fill();

        // 4. èº«ä½“ä¸»ä½“
        ctx.fillStyle = g;
        ctx.beginPath();
        if(type === 'shark') ctx.ellipse(0,0, r*1.3, r*0.65, 0, 0, Math.PI*2);
        else if(type === 'whale') ctx.ellipse(0,0, r*1.1, r*0.85, 0, 0, Math.PI*2);
        else ctx.ellipse(0,0, r, r*0.75, 0, 0, Math.PI*2);
        ctx.fill();

        // 5. çœ¼ç›
        const ex = r*0.4, ey = r*0.35, es = r*0.22;
        ctx.fillStyle='#fff'; 
        ctx.beginPath(); ctx.arc(ex, -ey, es, 0, 6.28); ctx.fill();
        ctx.beginPath(); ctx.arc(ex, ey, es, 0, 6.28); ctx.fill();
        ctx.fillStyle='#000';
        ctx.beginPath(); ctx.arc(ex+1, -ey, es*0.5, 0, 6.28); ctx.fill();
        ctx.beginPath(); ctx.arc(ex+1, ey, es*0.5, 0, 6.28); ctx.fill();

        // 6. ç¯ç¬¼é±¼ç‰¹æ•ˆ
        if(type === 'angler') {
            ctx.strokeStyle='#888'; ctx.lineWidth=2;
            ctx.beginPath(); ctx.moveTo(r*0.5, -r*0.2); ctx.quadraticCurveTo(r, -r*1.5, r*1.5, -r*1.2); ctx.stroke();
            ctx.fillStyle='#ff0'; ctx.shadowBlur=20; ctx.shadowColor='#ff0';
            ctx.beginPath(); ctx.arc(r*1.5, -r*1.2, 5, 0, 6.28); ctx.fill(); ctx.shadowBlur=0;
        }

        ctx.restore();
    }
};

/* --- æ¸¸æˆé€»è¾‘ --- */
const Game = {
    cvs: null, ctx: null, W: 0, H: 0,
    state: 'STOP', loopId: null,
    
    cam: {x:0, y:0},
    p: { x:0, y:0, vx:0, vy:0, r:0, angle:0, tail:0, lives:3, inv:0, skills:{}, color:'#00f2fe' }, // ç¡®ä¿æœ‰ color
    
    enemies: [], parts: [], grid: [],
    keys: {}, lvlIdx: 0, saveId: null, shake: 0,

    init() {
        this.cvs = document.getElementById('gameCanvas');
        this.ctx = this.cvs.getContext('2d');
        this.resize();
        window.addEventListener('resize', ()=>this.resize());
        
        // ç”ŸæˆèƒŒæ™¯å‚ç…§ç‰© (é˜²æ­¢é»‘å±çœ‹èµ·æ¥åƒæ­»æœº)
        for(let i=0; i<80; i++) {
            this.grid.push({
                x: Math.random()*CFG.WORLD, y: Math.random()*CFG.WORLD,
                r: Math.random()*2+1, a: Math.random()*0.2
            });
        }

        window.addEventListener('keydown', e => {
            this.keys[e.key] = true;
            if(this.state==='PLAY') {
                if(e.code==='Space') this.cast('dash');
                if(e.code==='KeyJ') this.cast('shield');
                if(e.code==='KeyK') this.cast('magnet');
                if(e.code==='KeyL') this.cast('sonar');
            } else if(e.key==='Enter') UI.enter();
        });
        window.addEventListener('keyup', e => this.keys[e.key] = false);
    },

    resize() {
        this.W = window.innerWidth; this.H = window.innerHeight;
        this.cvs.width = this.W; this.cvs.height = this.H;
    },

    start(lvl, sid) {
        this.lvlIdx = lvl; this.saveId = sid;
        const cfg = CFG.LEVELS[lvl];

        this.p.x = CFG.WORLD/2; this.p.y = CFG.WORLD/2;
        this.p.vx = 0; this.p.vy = 0;
        this.p.r = cfg.startR;
        this.p.lives = 3; this.p.inv = 0;
        this.p.color = '#00f2fe'; // å¼ºåˆ¶é‡ç½®ç©å®¶é¢œè‰²
        
        this.cam.x = this.p.x - this.W/2; // ç«‹å³å¯¹é½æ‘„åƒæœº
        this.cam.y = this.p.y - this.H/2;

        ['dash','shield','magnet','sonar'].forEach(k => this.p.skills[k] = {cd:0, active:false});
        
        this.enemies = []; this.parts = [];
        this.state = 'PLAY';
        
        UI.setupHUD(cfg);
        this.loop();
    },

    nextLevel() { App.save(this.lvlIdx+1, this.p.r); this.start(this.lvlIdx+1, this.saveId); },
    retry() { this.start(this.lvlIdx, this.saveId); },

    loop() {
        if(this.state !== 'PLAY') return;
        this.ctx.clearRect(0,0,this.W,this.H);
        this.update();
        this.draw();
        this.loopId = requestAnimationFrame(()=>this.loop());
    },

    update() {
        const p = this.p;
        const lvl = CFG.LEVELS[this.lvlIdx];

        // 1. ç©å®¶ç§»åŠ¨
        let acc = 0.5;
        let max = 8 * (30/(p.r+20));
        if(p.skills.dash.active) max *= 2.5;

        if(this.keys['ArrowUp']||this.keys['w']) p.vy -= acc;
        if(this.keys['ArrowDown']||this.keys['s']) p.vy += acc;
        if(this.keys['ArrowLeft']||this.keys['a']) p.vx -= acc;
        if(this.keys['ArrowRight']||this.keys['d']) p.vx += acc;

        p.vx *= 0.94; p.vy *= 0.94;
        let spd = Math.sqrt(p.vx**2 + p.vy**2);
        if(spd > max) { p.vx=(p.vx/spd)*max; p.vy=(p.vy/spd)*max; }

        p.x += p.vx; p.y += p.vy;
        
        // è¾¹ç•Œ
        if(p.x<p.r) p.x=p.r; if(p.x>CFG.WORLD-p.r) p.x=CFG.WORLD-p.r;
        if(p.y<p.r) p.y=p.r; if(p.y>CFG.WORLD-p.r) p.y=CFG.WORLD-p.r;

        if(spd > 0.1) p.angle = Math.atan2(p.vy, p.vx);
        p.tail += 0.2 + spd*0.05;

        // æ‘„åƒæœºè·Ÿéš
        this.cam.x += (p.x - this.W/2 - this.cam.x) * 0.1;
        this.cam.y += (p.y - this.H/2 - this.cam.y) * 0.1;
        if(this.shake > 0) this.shake *= 0.9;

        // 2. æ•Œäººé€»è¾‘
        if(this.enemies.length < 22 && Math.random()<0.03) this.spawn(lvl);

        for(let i=this.enemies.length-1; i>=0; i--) {
            let e = this.enemies[i];
            
            if(e.stun > 0) { e.stun--; e.vx *= 0.9; e.vy *= 0.9; }
            else {
                // AI
                if(e.aggro && !p.skills.shield.active) {
                    let dx = p.x-e.x, dy = p.y-e.y;
                    let d = Math.sqrt(dx*dx+dy*dy);
                    if(d < 700) { e.vx += (dx/d)*0.2; e.vy += (dy/d)*0.2; }
                }
                if(p.skills.magnet.active && e.r < p.r) {
                    let dx = p.x-e.x, dy = p.y-e.y;
                    let d = Math.sqrt(dx*dx+dy*dy);
                    if(d < CFG.SKILLS.magnet.r) { e.vx += (dx/d)*0.8; e.vy += (dy/d)*0.8; }
                }
                e.x += e.vx; e.y += e.vy;
            }

            let es = Math.sqrt(e.vx**2 + e.vy**2);
            if(es > 0.1) e.angle = Math.atan2(e.vy, e.vx);
            e.tail += 0.15 + es*0.05;

            // å‰”é™¤
            if(Math.abs(e.x - p.x) > 2000 || Math.abs(e.y - p.y) > 2000) {
                this.enemies.splice(i,1); continue;
            }

            // ç¢°æ’
            let dist = Math.sqrt((p.x-e.x)**2 + (p.y-e.y)**2);
            if(dist < p.r + e.r*0.8) {
                if(p.r > e.r*1.1) {
                    // åƒ
                    this.enemies.splice(i,1);
                    p.r += e.r * 0.08;
                    this.boom(e.x, e.y, e.color);
                    UI.txt(`+${Math.floor(e.r)}`, e.x - this.cam.x, e.y - this.cam.y, '#ffd700');
                    UI.hud();
                    if(p.r >= lvl.target) { this.state='PAUSED'; UI.show('p-win'); }
                } else if(e.r > p.r) {
                    // å—ä¼¤
                    if(p.inv <= 0 && !p.skills.shield.active) {
                        p.lives--; p.inv=120; this.shake=25;
                        UI.txt("WARNING", p.x - this.cam.x, p.y-50 - this.cam.y, '#ff0055');
                        UI.hud();
                        if(p.lives <= 0) { this.state='OVER'; UI.show('p-dead'); }
                    }
                }
            }
        }
        if(p.inv > 0) p.inv--;

        // 3. ç²’å­
        for(let i=this.parts.length-1; i>=0; i--) {
            let pt = this.parts[i];
            pt.x += pt.vx; pt.y += pt.vy; pt.l -= 0.03;
            if(pt.l <= 0) this.parts.splice(i,1);
        }

        // 4. CD
        for(let k in p.skills) {
            if(p.skills[k].cd > 0) { p.skills[k].cd -= 16; UI.cd(k, p.skills[k].cd); }
        }
    },

    spawn(lvl) {
        const k = lvl.spawns[Math.floor(Math.random()*lvl.spawns.length)];
        const proto = CFG.FISH[k];
        
        let ex, ey;
        if(Math.random()>0.5) {
            ex = this.cam.x + (Math.random()>0.5 ? -200 : this.W+200);
            ey = this.cam.y + Math.random()*this.H;
        } else {
            ex = this.cam.x + Math.random()*this.W;
            ey = this.cam.y + (Math.random()>0.5 ? -200 : this.H+200);
        }
        if(ex<0)ex=0; if(ex>CFG.WORLD)ex=CFG.WORLD;
        if(ey<0)ey=0; if(ey>CFG.WORLD)ey=CFG.WORLD;

        let r = proto.r[0] + Math.random()*(proto.r[1]-proto.r[0]);
        if(this.p.r > 100 && !proto.aggro && Math.random()<0.4) r *= 1.5;

        this.enemies.push({
            x:ex, y:ey, vx:(Math.random()-0.5)*proto.spd, vy:(Math.random()-0.5)*proto.spd,
            r:r, color:proto.color, type:proto.type, aggro:proto.aggro, // è¿™é‡Œä¿®å¤äº† proto.col -> proto.color
            angle:0, tail:0, stun:0
        });
    },

    boom(x, y, c) {
        for(let i=0; i<8; i++) this.parts.push({
            x:x, y:y, vx:(Math.random()-0.5)*12, vy:(Math.random()-0.5)*12,
            r:Math.random()*5+2, color:c, l:1
        });
    },

    cast(k) {
        if(!CFG.LEVELS[this.lvlIdx].skills.includes(k)) return;
        const s = this.p.skills[k];
        const cfg = CFG.SKILLS[k];
        if(s.cd <= 0 && !s.active) {
            s.active = true; s.cd = cfg.cd;
            if(k==='sonar') {
                this.shake = 40; this.enemies.forEach(e => e.stun = 180);
                UI.txt("SONAR!", this.p.x - this.cam.x, this.p.y-50 - this.cam.y, '#fff');
            } else {
                UI.txt(k.toUpperCase(), this.p.x - this.cam.x, this.p.y-50 - this.cam.y, '#fff');
            }
            setTimeout(() => s.active = false, cfg.dur);
        }
    },

    draw() {
        const ctx = this.ctx;
        const p = this.p;
        const lvl = CFG.LEVELS[this.lvlIdx];

        ctx.save();
        let sx = (Math.random()-0.5) * this.shake;
        let sy = (Math.random()-0.5) * this.shake;
        ctx.translate(-this.cam.x + sx, -this.cam.y + sy);

        // èƒŒæ™¯
        const bg = ctx.createLinearGradient(0,0,0,CFG.WORLD);
        bg.addColorStop(0, lvl.bg[0]); bg.addColorStop(1, lvl.bg[1]);
        ctx.fillStyle = bg; ctx.fillRect(0,0,CFG.WORLD, CFG.WORLD);
        
        ctx.strokeStyle = 'rgba(255,255,255,0.1)'; ctx.lineWidth=20;
        ctx.strokeRect(0,0,CFG.WORLD, CFG.WORLD);

        // å‚ç…§ç‰© (é‡è¦ï¼šé˜²æ­¢é»‘å±æ„Ÿ)
        ctx.fillStyle = 'rgba(255,255,255,0.1)';
        this.grid.forEach(d => {
            ctx.beginPath(); ctx.arc(d.x, d.y, d.r, 0, 6.28); ctx.fill();
        });

        // æ·±æµ·å…‰ç…§
        if(lvl.dark > 0) {
            ctx.fillStyle = `rgba(0,0,0,${lvl.dark})`;
            ctx.fillRect(this.cam.x-50, this.cam.y-50, this.W+100, this.H+100);
            ctx.globalCompositeOperation = 'destination-out';
            
            this.light(p.x, p.y, p.r*5+300);
            this.enemies.forEach(e => { if(e.type==='angler') this.light(e.x, e.y, e.r*4+100); });
            ctx.globalCompositeOperation = 'source-over';
        }

        // æŠ€èƒ½
        if(p.skills.shield.active) {
            ctx.strokeStyle='#ffd700'; ctx.lineWidth=4; ctx.setLineDash([15,10]);
            ctx.beginPath(); ctx.arc(p.x, p.y, p.r+30, 0, 6.28); ctx.stroke(); ctx.setLineDash([]);
        }
        if(p.skills.magnet.active) {
            ctx.strokeStyle='rgba(189,0,255,0.2)'; ctx.lineWidth=2;
            ctx.beginPath(); ctx.arc(p.x, p.y, CFG.SKILLS.magnet.r, 0, 6.28); ctx.stroke();
        }
        if(p.skills.sonar.active) {
            ctx.strokeStyle='rgba(255,255,255,0.5)'; ctx.lineWidth=20;
            ctx.beginPath(); ctx.arc(p.x, p.y, CFG.SKILLS.sonar.r, 0, 6.28); ctx.stroke();
        }

        // å®ä½“
        this.enemies.forEach(e => Render.fish(ctx, e.x, e.y, e.r, e.angle, e.color, e.type, e.tail));
        if(p.inv%10 < 5) Render.fish(ctx, p.x, p.y, p.r, p.angle, p.color, 'player', p.tail);

        // ç²’å­
        this.parts.forEach(pt => {
            ctx.globalAlpha = pt.l; ctx.fillStyle = pt.color;
            ctx.beginPath(); ctx.arc(pt.x, pt.y, pt.r, 0, 6.28); ctx.fill();
        });
        ctx.globalAlpha = 1;

        ctx.restore();
    },

    light(x, y, r) {
        const g = this.ctx.createRadialGradient(x, y, r*0.1, x, y, r);
        g.addColorStop(0, 'rgba(0,0,0,1)'); g.addColorStop(1, 'rgba(0,0,0,0)');
        this.ctx.fillStyle=g; this.ctx.beginPath(); this.ctx.arc(x, y, r, 0, 6.28); this.ctx.fill();
    }
};

/* --- UI --- */
const UI = {
    show(id) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        if(id) document.getElementById(id).classList.add('active');
    },
    enter() {
        if(document.getElementById('p-pass').classList.contains('active')) App.checkPass();
        else if(document.getElementById('p-login').classList.contains('active')) App.login();
    },
    setupHUD(lvl) {
        this.show(''); document.getElementById('hud').style.display = 'block';
        document.getElementById('v-zone').innerText = lvl.name;
        ['dash','shield','magnet','sonar'].forEach(k => {
            document.getElementById(`s-${k}`).style.display = lvl.skills.includes(k) ? 'flex' : 'none';
        });
        this.hud();
    },
    hud() {
        document.getElementById('v-size').innerText = Math.floor(Game.p.r);
        document.getElementById('v-lives').innerText = Game.p.lives;
    },
    cd(k, val) {
        const pct = (val/CFG.SKILLS[k].cd)*100;
        document.getElementById(`c-${k}`).style.height = pct+'%';
        const b = document.getElementById(`s-${k}`);
        if(val<=0) b.classList.add('active'); else b.classList.remove('active');
    },
    txt(t, x, y, c) {
        if(x<0||x>Game.W||y<0||y>Game.H) return;
        const d = document.createElement('div'); d.className='float-txt'; d.innerText=t;
        d.style.left=x+'px'; d.style.top=y+'px'; d.style.color=c;
        document.getElementById('ui-layer').appendChild(d);
        setTimeout(()=>d.remove(), 1000);
    }
};

/* --- App Logic --- */
const App = {
    user: null,
    checkPass() {
        if(document.getElementById('inp-pass').value === CFG.PASS) UI.show('p-login');
        else alert('å¯†ç æ— æ•ˆ');
    },
    login() {
        const v = document.getElementById('inp-user').value.trim().toUpperCase();
        if(v && /^[A-Z]+$/.test(v)) { this.user=v; this.loadSaves(); }
        else alert('æ— æ•ˆä»£å·');
    },
    loadSaves() {
        UI.show('p-saves');
        const l = document.getElementById('slot-list'); l.innerHTML='';
        const s = Store.get(`DS_${this.user}`) ? JSON.parse(Store.get(`DS_${this.user}`)) : [];
        if(s.length===0) l.innerHTML = '<div style="color:#888">æš‚æ— æ•°æ®</div>';
        s.forEach(x => {
            const d = document.createElement('div'); d.className='slot';
            d.innerHTML = `
                <div onclick="Game.start(${x.lvl}, ${x.id})">
                    <b style="color:var(--gold)">${CFG.LEVELS[x.lvl].name}</b>
                    <span style="font-size:0.8em;color:#aaa">Size: ${Math.floor(x.score)}</span>
                </div>
                <div style="color:red;padding:0 10px" onclick="App.del(${x.id})">Ã—</div>
            `;
            l.appendChild(d);
        });
    },
    newGame() { Game.start(0, null); },
    save(lvl, score) {
        let s = Store.get(`DS_${this.user}`) ? JSON.parse(Store.get(`DS_${this.user}`)) : [];
        if(Game.saveId) {
            let i = s.findIndex(x=>x.id===Game.saveId);
            if(i>=0) { s[i].lvl=lvl; s[i].score=score; }
        } else {
            Game.saveId = Date.now();
            if(s.length>=4) s.shift();
            s.push({id:Game.saveId, lvl:lvl, score:score});
        }
        Store.set(`DS_${this.user}`, JSON.stringify(s));
    },
    del(id) {
        if(!confirm('åˆ é™¤?'))return;
        let s = JSON.parse(Store.get(`DS_${this.user}`));
        s = s.filter(x=>x.id!==id);
        Store.set(`DS_${this.user}`, JSON.stringify(s));
        this.loadSaves();
    },
    saveQuit() {
        this.save(Math.min(Game.lvlIdx+1, 1), Game.p.r);
        this.loadSaves();
    }
};

window.onload = () => { Game.init(); UI.show('p-pass'); };
</script>
</body>
</html>
